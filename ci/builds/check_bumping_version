#!/bin/bash

# Required environment:
# MIXBOX_PUSHSPEC_VERSION (e.g. "0.0.1")
# MIXBOX_PUSHSPEC_ORIGIN (e.g. "origin")

set -e

for include in "$(dirname $0)/../include/"*; do source "$include"; done

if [ "$CLEAR_CACHES" == "true" ]
then
    pod cache clean --all
    rm -rf ~/Library/Caches/CocoaPods/Pods
    rm -rf ~/Library/Developer/Xcode/DerivedData/
    rm -rf ~/.cocoapods/repos/MixboxSpecRepo

    tag="Mixbox-$MIXBOX_PUSHSPEC_VERSION"
    git tag -d "$tag"
    git tag "$tag"
    git push --force "$MIXBOX_PUSHSPEC_ORIGIN" "$tag"
    
    pod repo add MixboxSpecRepo "file:///$MIXBOX_CI_REPO_ROOT"
    
    echo "Caches were cleared"
fi

MIXBOX_PUSHSPEC_STYLE=debug "$MIXBOX_CI_REPO_ROOT/ci/builds/push_specs"

cd "$MIXBOX_CI_REPO_ROOT/Demo"
LOCAL_SPEC_REPO=true pod update
